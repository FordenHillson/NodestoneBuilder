var skillData = {"Adele":["Blade of Will","Magic Dispatch","Skewering","Impale","Aether Forge","Eviscerate","Reign of Destruction","Cleave","Hunting Decree","Aether Bloom"],"Angelic Buster":["Soul Buster","Star Bubble","Lovely Sting","Pink Pummel","Soul Seeker","Shining Star Burst","Heavenly Crash","Celestial Roar","Trinity","Finale Ribbon","Soul Resonance","Supreme Supernova"],"Aran":["Smash Wave","Smash Swing","Final Charge","Final Attack","Final Toss","Rolling Spin","Judgment Draw","Gathering Hook","Final Blow","Beyond Blade","Finisher - Storm of Fear","Finisher - Hunter's Prey","Maha's Domain"],"Ark":["Overcharge Drive","Ominous Nightmare","Scarlet Charge Drive","Unstoppable Impulse","Impending Death","Gust Charge Drive","Abyssal Charge Drive","Endless Agony"],"Battle Mage":["Triple Blow","Condemnation","Quad Blow","Dark Chain","Quintuple Blow","Battle Burst","Dark Shock","Finishing Blow","Dark Genesis","Sweeping Staff"],"Beast Tamer":["Paw Swipe","Deep Breath","Really Deep Breath","Li'l Fort","Fishy Slap","Table Flip","Leopard's Paw","Macho Dance","Thunder Dash","Three-Point Pounce","Party Time","Formation Attack","Tornado Flight","Friend Launcher","Fire Kitty!","Group Bear Blaster"],"Bishop":["Heal","Holy Arrow","Shining Ray","Big Bang","Bahamut","Angel Ray","Genesis","Heaven's Door"],"Blaster":["Magnum Punch","Revolving Cannon","Bunker Buster Explosion","Detonate","Double Blast","Hammer Smash","Magnum Launch","Shotgun Punch","Muzzle Flash","Ballistic Hurricane","Revolving Blast","Hyper Magnum"],"Blaze Wizard":["Orbital Flame","Flame Bite","Flame Vortex","Ignition","Flame Tempest","Cinder Maelstrom","Blazing Extinction","Towering Inferno","Cataclysm","Dragon Blaze"],"Bowmaster":["Arrow Blow","Final Attack","Wind Arrow","Phoenix","Covering Fire","Arrow Blaster","Hurricane","Arrow Stream","Quiver Cartridge","Gritty Gust"],"Buccaneer":["Sea Serpent Burst","Static Thumper","Turning Kick","Corkscrew Blow","Sea Serpent's Rage","Octopunch","Nautilus Strike","Hook Bomber"],"Cadena":["Reign of Chains","Summon Scimitar","Summon Daggers","Summon Shotgun","Summon Brick","Beatdown","Summon Spiked Bat","Veteran Shadowdealer"],"Cannoneer":["Cannon Blaster","Cannon Strike","Blast Back","Scatter Shot","Barrel Bomb","Cannon Spike","Cannon Jump","Barrel Roulette","Monkey Fury","Cannon Bazooka","Nautilus Strike","Anchors Away","Monkey Militia","Cannon Barrage","Rolling Rainbow"],"Corsair":["Rapid Blast","Recoil Shot","Scurvy Summons","Blunderbuster","Blackboot Bill","Siege Bomber","Rapid Fire","Nautilus Strike","Brain Scrambler","Eight-Legs Easton","Majestic Presence","Broadside","Parrotargetting","Ugly Bomb"],"Dark Knight":["Final Attack","Spear Sweep","La Mancha Spear","Rush","Evil Eye","Dark Impale","Gungnir's Descent","Nightshade Explosion"],"Dawn Warrior":["Triple Slash","Bluster","Shadow Tackle","Light Merger","Moon Cross","Speeding Sunset","Solar Pierce","Impaling Rays","Styx Crossing","Equinox Slash"],"Demon Avenger":["Exceed Double Slash","Exceed Demon Strike","Bat Swarm","Exceed Lunar Slash","Vitality Veil","Shield Charge","Exceed Execution","Nether Shield","Nether Slice","Blood Prison","Thousand Swords","Infernal Exceed"],"Demon Slayer":["Grim Scythe","Demon Lash","Soul Eater","Dark Thrust","Chaos Lock","Vengeance","Judgment","Vortex of Doom","Raven Storm","Carrion Breath","Infernal Concussion","Demon Impact","Demon Cry","Dark Metamorphosis","Binding Darkness","Cerberus Chomp"],"Dual Blade":["Bandit Slash","Tornado Spin","Fatal Blow","Slash Storm","Flashbang","Blade Ascension","Flying Assaulter","Bloody Storm","Chains of Hell","Final Cut","Blade Fury","Phantom Blow","Sudden Raid","Asura's Anger","Blade Clone"],"Evan":["Mana Burst","Dragon Spark","Wind Circle","Dragon Flash","Thunder Circle","Dragon Dive","Magic Debris","Earth Circle","Dragon Breath","Dark Fog","Dragon Master","Summon Onyx Dragon"],"Fire Poison Mage":["Flame Orb","Poison Breath","Ignite","Explosion","Poison Mist","Teleport Mastery","Flame Haze","Mist Eruption","Ifrit","Flame Sweep","Meteor Shower","Inferno Aura","Megiddo Flame"],"Hayato":["Summer Rain","Hitokiri Hundred Strike","Sanrenzan","Blade Flash","Surging Blade","Shouryuusen","Jin Sanrenzan","Vapor Blade","Jin Blade Flash","Rising Slash","Falcon Dive","Fuu Sanrenzan","Fuu Blade Flash","Sweeping Sword","Whirlwind Cut","Dankuusen","Rai Sanrenzan","Rai Blade Flash","Tornado Blade","Sudden Strike","Shinsoku","Hitokiri Strike","Falcon's Honor"],"Hero":["Final Attack","Brandish","Flash Blade","Intrepid Slash","Rush","Cry Valhalla","Beam Blade","Raging Blow","Puncture","Rising Rage"],"Hoyoung":["Humanity","Earth","Heaven","Evil-Sealing Gourd","Ghost Flame","Degeneration","Butterfly Dream","Star Vortex","Clone"],"Ice Lightning Mage":["Thunder Bolt","Cold Beam","Chilling Step","Ice Strike","Frost Ward","Thunder Sphere","Elquines","Chain Lightning","Blizzard","Frozen Orb","Lightning Orb"],"Illium":["Radiant Javelin II","Umbral Brand III","Reaction - Destruction II","Machina","Vortex Wings","Longinus Spear","Longinus Zone","Deus"],"Jett":["Starline One","Blaster Barrage","Starline Two","Stellar Impact","Vortex Cross","Falling Stars","Starline Three","Cosmic Upheaval","Starforce Salvo","Backup Beatdown","Planet Buster","Singularity Shock"],"Kain":["Strike Arrow","Scattering Shot","Dragon Fang","Shaft Break","Phantom Blade","Death's Blessing","Falling Dust","Chain Sickle"],"Kaiser":["Dragon Slash","Flame Surge","Impact Wave","Piercing Blaze","Tempest Blades","Wing Beat","Pressure Chain","Stone Dragon","Gigas Wave","Dragon Barrage","Blade Burst","Inferno Breath","Ancestral Prominence"],"Kanna":["Shikigami Haunting","Ghost Yaksha Boss","Kishin Shoukan","Nightghost Guide","Shikigami Charm","Exorcist's Charm","Tengu Strike","Yosuzume","Vanquisher's Charm","Orochi Unbound","Falling Sakura","Binding Tempest","Nine-Tailed Fury","Shikigami Doppelganger","Veritable Pandemonium"],"Kinesis":["Psychic Force","Kinetic Crash","Kinetic Piledriver","Ultimate - Deep Impact","Psychic Drain","Psychic Grab","Ultimate - Trainwreck","Kinetic Combo","Mind Break","Ultimate - B.P.M.","Mental Tempest","Mental Shock","Ultimate - Metal Press"],"Lara":["Essence Sprinkle","Wakeup Call","Mountain Kid","Mountain Seeds","Dragon Vein Eruption","Dragon Vein Absorption","Vine Coil","Dragon Vein Traces"],"Luminous":["Flash Shower","Abyssal Drop","Sylvan Lance","Pressure Void","Spectral Light","Ray of Redemption","Moonlight Spear","Death Scythe","Reflection","Morning Star","Apocalypse","Ender","Armageddon"],"Marksman":["Arrow Blow","Final Attack","Iron Arrow","Bolt Burst","Piercing Arrow","Snipe","High Speed Shot"],"Mechanic":["ME-07 Drillhands","Gatling Gun","Rocket Booster","Heavy Gatling Gun","Homing Beacon","Robo Launcher RM7","Punch Launcher","Rock 'n Shock","Heavy Salvo","Support Unit H-EX","Giant Robot SG-88","Bots 'n Tots","Heavy Salvo Plus","Distortion Bomb"],"Mercedes":["Swift Dual Shot","Rising Rush","Stunning Strikes","Leaf Tornado","Unicorn Spike","Elemental Knights","Ishtar's Ring","Spikes Royale","Lightning Edge","Wrath of Enil"],"Mihile":["Soul Blade","Royal Guard","Soul Driver","Radiant Driver","Trinity Attack","Four-Point Assault","Radiant Cross","Charging Light","Final Attack"],"Night Lord":["Shuriken Burst","Gust Charm","Assassin's Mark","Dark Flare","Triple Throw","Shuriken Challenge","Quad Star","Sudden Raid","Showdown","Death Star"],"Night Walker":["Lucky Seven","Shadow Bat","Triple Throw","Quad Star","Shadow Spark","Quintuple Star","Dark Omen","Shadow Stitch","Dominion"],"Paladin":["Final Attack","Divine Swing","Close Combat","Divine Judgment","Rush","Divine Charge","Blast","Heaven's Hammer","Smite Shield"],"Pathfinder":["Cardinal Deluge","Cardinal Burst","Cardinal Torrent","Shadow Raven","Swarm Shot","Triple Impact","Glyph of Impalement","Combo Assault","Ancient Astra"],"Phantom":["Double Entendre","Calling Card","Carte Mille","Carte Blanc","Blason Fantome","Rapier Wit","Mille Aiguilles","Penombre","Tempest","Rose Carte Finale","Impeccable Memory I","Impeccable Memory II","Impeccable Memory III","Impeccable Memory IV"],"Shade":["Flash Fist","Ground Pound","Blade Imp - Downward Slash","Blade Imp - Forward Slash","Fox Spirits","Shockwave Punch","Blade Imp - Spin Slash","Spirit Frenzy","Spirit Trap","Spirit Redemption","Bomb Punch","Spirit Claw","Death Mark","Soul Splitter","Spirit Incarnation"],"Shadower":["Savage Blow","Phase Dash","Meso Explosion","Midnight Carnival","Dark Flare","Assassinate","Cruel Stab","Sudden Raid","Shadow Veil"],"Thunder Breaker":["Lightning Punch","Flash","Shark Sweep","Tidal Crash","Ascension","Thunder","Gale","Annihilate","Thunderbolt","Deep Rising"],"Wild Hunter":["Double Shot","Summon Jaguar","Swipe","Final Attack","Dash 'n Slash","White Heat Rush","Enduring Fire","Hunting Assistant Unit","Sonic Roar","Wild Arrow Blast","Drill Salvo","Exploding Arrows"],"Wind Archer":["Breeze Arrow","Fairy Spiral","Gust Shot","Trifling Wind","Sentient Arrow","Pinpoint Pierce","Song of Heaven","Spiraling Vortex","Monsoon","Storm Bringer"],"Xenon":["Beam Spline","Pinpoint Salvo","Quicksilver","Ion Thrust","Combat Switch","Diagonal Chase","Gravity Pillar","Aegis System","Triangulation Boost","Beam Dance","Mecha Purge","Hypogram Field","Entangling Lash","Orbital Cataclysm"],"Zero":["Moon Strike","Piercing Thrust","Flash Assault","Spin Cutter","Rolling Cross","Rolling Assault","Wind Cutter","Wind Striker","Storm Break","Shadow Rain"],"墨玄":["玄山 招式全開","神功 破碎拳","神功 旋風脚","神功 鐵山靠","神功 亂拳連激","神功 无影脚","密技 千斤錘","神功 大地崩裂","神功 移形換位","眞氣 焦熱破神擊"]};
var logicNumber = 4;
var skillCopy = 2;
var selectorChangeId = ["#skillOne","#skillTwo","#skillThree"];
var formTrio = ["SKILL1","SKILL2","SKILL3"];
var previewChangeId = ["#prev1","#prev2","#prev3"];
var selectedJob;
var nodestones = [];
var selectedSkills = [];
var cannotLead = [];
var nodeTally = {};
var nodeCollection = [];

/**
 * Adds a new nodestone (created by the user)
 * Not in use since the UI update
 */
/*function addNodestone(){
  var firstSkill = $("#skillOne").val();
  var secondSkill = $("#skillTwo").val();
  var thirdSkill = $("#skillThree").val();
  if ((firstSkill != secondSkill) && (firstSkill != thirdSkill) && (secondSkill != thirdSkill)){
      var currentNodestone = [firstSkill,secondSkill,thirdSkill];
      if(isAlreadyIn(nodestones,currentNodestone)){
          alert("Node Combination Already Exists");
      }
      else {
        nodestones.push(currentNodestone);
        newNode(currentNodestone);
      }
      
  }
  else {
      alert("A Skill Cannot Appear in a node more than once.");
  }
};*/

/**
 * Adds a new nodestone (created by the user)
 * Function for the new UI
 */
 function addNodestone2(){
    var firstSkill = formTrio[0];
    var secondSkill = formTrio[1];
    var thirdSkill = formTrio[2];
    if ((formTrio[0] != formTrio[1]) && (formTrio[1] != formTrio[2]) && (formTrio[2] != formTrio[0])){
        var currentNodestone = [firstSkill,secondSkill,thirdSkill];
        if(isAlreadyIn(nodestones,formTrio)){
            alert("Node Combination Already Exists");
        }
        else {
          nodestones.push(currentNodestone);
          newNode(formTrio);
        }
        
    }
    else {
        alert("A Skill Cannot Appear in a node more than once.");
    }
  };

/**
 * Checks whether "item" is already inside "arr" (an array)
 */

function isAlreadyIn(arr, item){
    var itemString = JSON.stringify(item);
    var contain = arr.some(function(ele){
        return JSON.stringify(ele) === itemString;
    });
    return contain;
}

/**
 * Creates a new entry in the nodestone collection panel based on data from nodeSet(an array of size 3) 
 */
function newNode(nodeSet){
    var tableRef = document.getElementById("nodeList").getElementsByTagName("tbody")[0];
    var newRow   = tableRef.insertRow();
    var newCell  = newRow.insertCell(0);
    newCell.setAttribute("name","imageName");
    var newLiner = document.createElement("br");
    var newText  = document.createTextNode(nodeSet[0]+"\n"+nodeSet[1]+"\n"+nodeSet[2]);
    newCell.appendChild(newText);
    var newCell  = newRow.insertCell(1);
    newCell.setAttribute("name","imageCell");
    var newImg   = document.createElement("img");
    newImg.setAttribute("src","Images/"+ selectedJob + "/"+ nodeSet[0] + ".png");
    newImg.setAttribute("name","firstSlice");//trial
    newCell.appendChild(newImg);
    var newImg   = document.createElement("img");
    newImg.setAttribute("src","Images/"+ selectedJob + "/"+ nodeSet[1] + ".png");
    newImg.setAttribute("name","secondSlice");
    newCell.appendChild(newImg);
    var newImg   = document.createElement("img");
    newImg.setAttribute("src","Images/"+ selectedJob + "/"+ nodeSet[2] + ".png");
    newImg.setAttribute("name","thirdSlice");
    newCell.appendChild(newImg);
    var newImg   = document.createElement("img");
    newImg.setAttribute("src","Images/MapleDivider.png");
    newImg.setAttribute("name","divider");
    newCell.appendChild(newImg);
    var newCell  = newRow.insertCell(2);
    var newText  = document.createTextNode("SCORE");
    newCell.appendChild(newText);
    var newCell  = newRow.insertCell(3);
    var b = document.createElement('button');
    b.setAttribute("class","btn btn-primary");
    b.textContent = 'Add';
    b.onclick = function(){
        if(!isAlreadyIn(nodeCollection, nodestones[$(this).closest('tr').attr("name")]) && !isAlreadyIn(cannotLead,nodestones[$(this).closest('tr').attr("name")][0])){
            disableDeletion(true);
            $(this).closest('tr').removeClass("bg-danger bg-warning bg-success");
            $(this).closest('tr').addClass("bg-info");
            updateNodeScore(nodestones[$(this).closest('tr').attr("name")],"ADD");
            nodeCollection.push(nodestones[$(this).closest('tr').attr("name")]);
            cannotLead.push(nodestones[$(this).closest('tr').attr("name")][0]);
            computeNodeScoreAll();
            computeAuxData();
            copyToCollection($(this).closest('tr').attr("name"));
        }
        else{
            alert("The trio you are trying to add is either already in or the leading skill conflicts with items inside the list. \n If you are using the Auto-Build function, just press OK to continue the process.");
        }

        return false;
    };
    newCell.appendChild(b); 
    var newCell  = newRow.insertCell(4);
    var c = document.createElement('button');
    c.setAttribute("class","btn btn-primary");
    c.setAttribute("name","delete");
    c.textContent = 'Remove';
    c.onclick = function(){
        nodestones.splice($(this).closest('tr').attr("name"), 1);
        changeOrder($(this).closest('tr').attr("name"));
        $(this).closest('tr').remove();
        return false;
    };
    newCell.appendChild(c);
    $("#nodeList  tr:last").attr("name", ($("#nodeList tr").length)-2);
    if($("#nodeCombo tbody tr").length != 0){
        disableDeletion(true);
    }
    computeNodeScoreAll();
}

/**
 * Originally was supposed to load all skill data from a JSON file.
 * Current use is to load all supported jobs in the "Select Job:" dropdown
 */
function loadJSON(){
    for (jobs in skillData){
        var jobSelection = document.getElementById("jobSelect");
            jobSelection.innerHTML = jobSelection.innerHTML +
                '<option value="' + jobs + '">' + jobs + '</option>';
    }
}

/**
 * Changes the list of skills a user can pick to rebuild their tri-nodes.
 * Also in charge of hiding certain div's based on selectedJob's value (should be moved to a separate function)
 */
function skillChange(){
    selectedJob = $("#jobSelect").val();
    initializeTally();
    selectorChange();
    clearLeftoverData();
    var firstNode = document.getElementById("skillOne");
    var secondNode = document.getElementById("skillTwo");
    var thirdNode = document.getElementById("skillThree");
    //firstNode.innerHTML=null;
    //secondNode.innerHTML=null;
    //thirdNode.innerHTML=null;
    if(selectedJob.length > 0)
    {
        $("#normalOperation").attr("name","noOp");
        $("#helpOperation").attr("name","hiddenObj");
        $("#optionOperation").attr("name","hiddenObj");
        /*for (i = 0; i < skillData[selectedJob].length; i++){
            firstNode.innerHTML = firstNode.innerHTML +
                    '<option value="' + skillData[selectedJob][i] + '">' + skillData[selectedJob][i] + '</option>';
                    secondNode.innerHTML = secondNode.innerHTML +
                    '<option value="' + skillData[selectedJob][i] + '">' + skillData[selectedJob][i] + '</option>';
                    thirdNode.innerHTML = thirdNode.innerHTML +
                    '<option value="' + skillData[selectedJob][i] + '">' + skillData[selectedJob][i] + '</option>';
        }
        document.getElementById("nodestoneAdd").style.display = "table-cell" 
        $("#prev1").attr("src","Images/"+ selectedJob + "/"+ skillData[selectedJob][0] + ".png");
        $("#prev2").attr("src","Images/"+ selectedJob + "/"+ skillData[selectedJob][0] + ".png");
        $("#prev3").attr("src","Images/"+ selectedJob + "/"+ skillData[selectedJob][0] + ".png");*/
    }
    else{
        $("#normalOperation").attr("name","hiddenObj");
        $("#helpOperation").attr("name","noOp");
        $("#optionOperation").attr("name","noOp");
        //document.getElementById("nodestoneAdd").style.display = "none";
    }
}

/**
 * Changes the Skill icon preview in build nodestone
 */
function previewChange(changedPart){
    
    $(previewChangeId[changedPart-1]).attr("src","Images/"+ selectedJob + "/"+ $(selectorChangeId[changedPart-1]).val() + ".png");
}

/**
 * Changes the amount of copies a skill should have 
 */
function numberChange(){
    skillCopy = $("#copyNumber").val();
}

/**
 * Changes the selectable skills in the first div which users pick to select which skills they would like their perfect trios to have
 */
function selectorChange(){
    var tableNode = document.getElementById("skillOption1");
    tableNode.innerHTML = "";
    nodestones = [];
    selectedSkills = [];
    cannotLead = [];
    nodeCollection = [];
    document.getElementById("nodeList").getElementsByTagName("tbody")[0].innerHTML = "";
    document.getElementById("nodeCombo").getElementsByTagName("tbody")[0].innerHTML = "";
    selectedJob = $("#jobSelect").val();
    updateNodeScore(["A","B","C"],"Nothing");
    if(selectedJob.length > 0){
        var tableRef = document.getElementById("skillOption1");
        for (i = 0; i < skillData[selectedJob].length; i++){
            if(i%5 == 0){
                var newRow = tableRef.insertRow();
            }
            var newCell  = newRow.insertCell(i%5);
            var newImg   = document.createElement("img");
            newImg.setAttribute("src","Images/"+ selectedJob + "/"+ skillData[selectedJob][i] + ".png");
            newCell.appendChild(newImg);
            var newText  = document.createTextNode(" "+ skillData[selectedJob][i]);
            newCell.appendChild(newText);
            newCell.setAttribute("name", skillData[selectedJob][i]);
            newCell.setAttribute("onclick", 'formulateTrios("'+skillData[selectedJob][i]+'")');
        }
    }
    selectorChangeTri();
}

/**
 * Changes the selectable skills in the first div which users pick to select which skills they would like their perfect trios to have
 */
 function selectorChangeTri(){
    var tableNode = document.getElementById("skillOption1p5");
    tableNode.innerHTML = "";
    selectedJob = $("#jobSelect").val();
    if(selectedJob.length > 0){
        $('#prev1a').attr("src","Images/MapleDivider.png");
        $('#prev2a').attr("src","Images/MapleDivider.png");
        $('#prev3a').attr("src","Images/MapleDivider.png");
        $('#textSel1').text("");
        $('#textSel2').text("");
        $('#textSel3').text("");
        var tableRef = document.getElementById("skillOption1p5");
        for (var i = 0; i < skillData[selectedJob].length; i++){
            if(i%5 == 0){
                var newRow = tableRef.insertRow();
            }
            var newCell  = newRow.insertCell(-1);
            var newImg   = document.createElement("img");
            newImg.setAttribute("src","Images/"+ selectedJob + "/"+ skillData[selectedJob][i] + ".png");
            newCell.appendChild(newImg);
            //var newText  = document.createTextNode(" "+ skillData[selectedJob][i]);
            //newCell.appendChild(newText);
            newCell.setAttribute("name", skillData[selectedJob][i]);
            //newCell.setAttribute("onclick", 'formulateTrios("'+skillData[selectedJob][i]+'")');
            for(var j = 0; j < 3; j++){
                var newText = document.createTextNode("");
                var newCell = newRow.insertCell(-1);
                newCell.appendChild(newText);
                newCell.setAttribute("name", skillData[selectedJob][i] +"_slot_"+(j+1));
                newCell.setAttribute("class", "slot_"+(j+1));
                //newCell.addClass("segmentSelect"+(j+1));
                newCell.setAttribute("onclick", 'selectSegment("'+skillData[selectedJob][i]+'",'+j+')');
            }
        }
    }
}

/**
 * 
 * New Logic for creation of Trios 
 */
function selectSegment(skillName, segment){
    formTrio[segment]=skillName;
    $('td.slot_'+(segment+1)+'[name="'+skillName+'_slot_'+ (segment+1)+'"]').addClass("bg-primary");
    $('td.slot_'+ (segment+1) +':not(td[name="'+skillName+'_slot_'+ (segment+1)+'"])').removeClass("bg-primary");
    $('#prev'+(segment+1)+'a').attr("src","Images/"+ selectedJob + "/"+ skillName + ".png");
    $('#textSel'+(segment+1)).text(skillName);

}

/**
 * UI Logic for the 1st div.
 * Also in charge of computing for a node statistic (Best Outcome)
 */
function formulateTrios(selectedOption){
    var nodeSlotData = 0;
    if(isAlreadyIn(selectedSkills,selectedOption)){
        selectedSkills = selectedSkills.filter(function(value, index, arr){ 
            return value != selectedOption;
        });
        $("#skillOption1 td[name=\""+selectedOption+"\"]").removeClass("bg-primary");
    }
    else{
        selectedSkills.push(selectedOption);
        $("#skillOption1 td[name=\""+selectedOption+"\"").addClass("bg-primary");
    }
    var selectedFormulation = selectedSkills.length;
    nodeSlotData = 3-(selectedFormulation*skillCopy%3);
    if(nodeSlotData == 3){
        nodeSlotData = 0;
    }
    var nodePositive = (Math.ceil(selectedFormulation*skillCopy/3)*3)-nodeSlotData;
    //console.log(nodePositive);
    document.getElementsByName("skillCounter")[0].innerHTML = selectedSkills.length;
    if(selectedFormulation == 1){
        document.getElementsByName("bestOutcome")[0].innerHTML = skillCopy+"("+skillCopy+" slots for selected and "+skillCopy*2+" slots for any skill)" ;
    }
    else{
        document.getElementsByName("bestOutcome")[0].innerHTML = Math.ceil(selectedFormulation*skillCopy/3) + "(" + nodePositive + " slots for selected and " + nodeSlotData + " slot(s) for any skill)" ;
    }
    initializeTally();
    computeNodeScore();
    updateNodeScore(["A","B","C"],"Nothing");
    computeAuxData();
    computeNodeScoreAll();

}

/**
 * Changes the name (ID #) of every node affected when a node is deleted.
 * Ex. removing node ID # 34 would result in 34 being empty. Nodes with ID 35 onwards would shift down to ensure ID 34 is used
 * This is the reason why deleting nodes is not allowed while ANY tri-node is equipped 
 */
function changeOrder(deletedNode){
    $('#nodeList > tbody  > tr').each(
        function(index) {
            if($(this).attr("name") > deletedNode){
                $(this).attr("name", $(this).attr("name")-1);
            }
        }
    )
    $('#nodeCombo > tbody  > tr').each(
        function(index) {
            if($(this).attr("name") > deletedNode){
                $(this).attr("name", $(this).attr("name")-1);
            }
        }
    )
}

/**
 * Initializes the tally/count if a skill is already present in the equipped tri-node twice/thrice (based on skillCopy).
 * A count of 2 means that said skill can still be equipped 2 more time, etc.
 */
function initializeTally(){
    selectedJob = $("#jobSelect").val();
    nodeTally=[];
    if(selectedJob.length > 0){
        for (i = 0; i < skillData[selectedJob].length; i++){
            if(isAlreadyIn(selectedSkills,skillData[selectedJob][i])){
                nodeTally[skillData[selectedJob][i]] =  skillCopy;
            }
            else {
                nodeTally[skillData[selectedJob][i]] = 0;
            }
        }

    }
}

/**
 * Copies the selected node to equip to the Equipped nodes list (inside div 3)
 */
function copyToCollection(selectName){
    var tableRef = document.getElementById("nodeCombo").getElementsByTagName("tbody")[0];
    var newRow   = tableRef.insertRow();
    var newCell  = newRow.insertCell(0);
    newCell.setAttribute("name","imageName");
    var newLiner = document.createElement("br");
    var newText  = document.createTextNode(nodestones[selectName][0]+"\n"+nodestones[selectName][1]+"\n"+nodestones[selectName][2]);
    newCell.appendChild(newText);
    var newCell  = newRow.insertCell(1);
    newCell.setAttribute("name","imageCell");
    var newImg   = document.createElement("img");
    newImg.setAttribute("src","Images/"+ selectedJob + "/"+ nodestones[selectName][0] + ".png");
    newImg.setAttribute("name","firstSlice");
    newCell.appendChild(newImg);
    var newImg   = document.createElement("img");
    newImg.setAttribute("src","Images/"+ selectedJob + "/"+ nodestones[selectName][1] + ".png");
    newImg.setAttribute("name","secondSlice");
    newCell.appendChild(newImg);
    var newImg   = document.createElement("img");
    newImg.setAttribute("src","Images/"+ selectedJob + "/"+ nodestones[selectName][2] + ".png");
    newImg.setAttribute("name","thirdSlice");
    newCell.appendChild(newImg);
    var newImg   = document.createElement("img");
    newImg.setAttribute("src","Images/MapleDivider.png");
    newImg.setAttribute("name","divider");
    newCell.appendChild(newImg);
    var newCell  = newRow.insertCell(2);
    var b = document.createElement('button');
    b.setAttribute("class","btn btn-primary");
    b.textContent = 'Unequip';
        b.onclick = function(){
        $('#nodeList > tbody  > tr[name="'+selectName+'"]').removeClass("bg-info");
        nodeCollection.splice(($(this).closest('td').parent()[0].sectionRowIndex), 1);
        cannotLead.splice(($(this).closest('td').parent()[0].sectionRowIndex), 1);
        updateNodeScore(nodestones[$(this).closest('tr').attr("name")],"REMOVE");
        computeNodeScoreAll();
        $(this).closest('tr').remove();
        disableDeletion(false);
        computeAuxData();
        return false;
    };
    newCell.appendChild(b);
    $("#nodeCombo  tr:last").attr("name", selectName);
}

/**
 * Enables or disables deletion in nodestone list
 */
function disableDeletion(statusLock){
    if(statusLock == true){
        $("#nodeList").find("button[name='delete']").attr("disabled", true);
       // $("#autoBuild").attr("disabled", true);
    }
    else if($("#nodeCombo tbody tr").length == 0){
        $("#nodeList").find("button[name='delete']").attr("disabled", false);
        $("#autoBuild").attr("disabled", false);
    }
}

/**
 * Deducts 1 to every skill currently equipped in the tally.
 */
function computeNodeScore(){
    for(i = 0; i < nodeCollection.length; i++){
        nodeTally[nodeCollection[i][0]] = nodeTally[nodeCollection[i][0]]-1;
        nodeTally[nodeCollection[i][1]] = nodeTally[nodeCollection[i][1]]-1;
        nodeTally[nodeCollection[i][2]] = nodeTally[nodeCollection[i][2]]-1;
    }
}

/**
 * Recomputes the nodescore for every skill inside the nodelist (div 2)
 * Fires off everytime a node is equipped, unequipped, or a skill is added or removed from the desired skills list
 */
function computeNodeScoreAll(){
    $('#nodeList > tbody  > tr').each(
        function(index) {
            if(!$(this).hasClass("bg-info")){
                $(this).removeClass("bg-danger bg-warning bg-success");
            }
            var nOne = nodestones[$(this).attr("name")][0];
            var nTwo = nodestones[$(this).attr("name")][1];
            var nThree = nodestones[$(this).attr("name")][2];
            var nScore = 0;
            if(isAlreadyIn(cannotLead,nOne)){
                nScore = -1;
            }
            else{
                if(isAlreadyIn(selectedSkills,nOne)){
                    nScore++;
                    if(nodeTally[nOne] > 0){
                        nScore++;
                    }
                }
                if(isAlreadyIn(selectedSkills,nTwo)){
                    nScore++;
                    if(nodeTally[nTwo] > 0){
                        nScore++;
                    }
                }
                if(isAlreadyIn(selectedSkills,nThree)){
                    nScore++;
                    if(nodeTally[nThree] > 0){
                        nScore++;
                    }
                }
                
            }
            //console.log(nScore)
            $("td:nth-last-child(3)",this).text(nScore);
            if(nScore == 0 && !$(this).hasClass("bg-info")){
                $(this).addClass("bg-danger");
            }
            else if(nScore < 6 && !$(this).hasClass("bg-info") && nScore > 0){
                $(this).addClass("bg-warning");
            }
            else if(nScore > 5 && !$(this).hasClass("bg-info")){
                $(this).addClass("bg-success");
            }
            else if(nScore < 1 && !$(this).hasClass("bg-info")){
                $(this).addClass("bg-danger");
                $("td:nth-last-child(3)",this).text("-1 (Leading Skill)");
            }
            else if(nScore < 0 && $(this).hasClass("bg-info")){
                $("td:nth-last-child(3)",this).text("-1 (In Use)");
            }
        }
    )

}

/**
 * Updates nodescores in tally based on if a node is equipped or unequipped.
 * Also is responsible for updating the lower right table in div 3 which is responsible for keeping track of how many times a skill appears in the equipped nodes (might want to move this function)
 */
function updateNodeScore(subtractNode, conditions){
    if(conditions == "ADD"){
        nodeTally[subtractNode[0]]= nodeTally[subtractNode[0]]-1;
        nodeTally[subtractNode[1]]= nodeTally[subtractNode[1]]-1;
        nodeTally[subtractNode[2]]= nodeTally[subtractNode[2]]-1; 
    }
    else if (conditions == "REMOVE"){
        nodeTally[subtractNode[0]]= nodeTally[subtractNode[0]]+1;
        nodeTally[subtractNode[1]]= nodeTally[subtractNode[1]]+1;
        nodeTally[subtractNode[2]]= nodeTally[subtractNode[2]]+1; 
    }
    var tableRef = document.getElementById("nodeStatistics2").getElementsByTagName("tbody")[0];
    tableRef.innerHTML = "";
    if(selectedJob.length > 0){
        for(k = 0; k < skillData[selectedJob].length; k++){
            var newRow   = tableRef.insertRow();
            var newCell  = newRow.insertCell(0);
            var newImg   = document.createElement("img");
            newImg.setAttribute("src","Images/"+ selectedJob + "/"+ skillData[selectedJob][k] + ".png");
            newCell.appendChild(newImg);
            var newText  = document.createTextNode(" "+ skillData[selectedJob][k]);
            newCell.appendChild(newText);
            var newCell  = newRow.insertCell(1);
            if(isAlreadyIn(selectedSkills, skillData[selectedJob][k])){
                var newText  = document.createTextNode("YES");
                newCell.appendChild(newText);
                var newCell  = newRow.insertCell(2);
                var newText  = document.createTextNode(skillCopy-nodeTally[skillData[selectedJob][k]]);
                if(skillCopy-nodeTally[skillData[selectedJob][k]] == skillCopy){
                    newRow.classList.add("bg-success");
                }
                else if(skillCopy-nodeTally[skillData[selectedJob][k]] < skillCopy){
                    newRow.classList.add("bg-warning");
                }
                else{
                    newRow.classList.add("bg-danger");
                }
            }
            else {
                var newText = document.createTextNode("NO");
                newCell.appendChild(newText);
                var newCell  = newRow.insertCell(2);
                var newText  = document.createTextNode(-nodeTally[skillData[selectedJob][k]]);
                newRow.classList.add("bg-info");
            }
            newCell.appendChild(newText);
        }
    }
}

/**
 * Computes other data in the Nodestatistics tab (# of nodes used, efficiency)
 */
function computeAuxData(){
    document.getElementsByName("nodeUsage")[0].innerHTML = nodeCollection.length;
    var tally = 0;
    for(j = 0; j < selectedSkills.length; j++){
        if(nodeTally[selectedSkills[j]] == 1){
            tally = tally +1;
        }
        else if (nodeTally[selectedSkills[j]] < 1){
            tally = tally +2;
        }
    }
    document.getElementsByName("nodeEfficiency")[0].innerHTML = tally + "/" + (nodeCollection.length)*3 + "(" + Math.round((tally/(nodeCollection.length*3)*100 + Number.EPSILON) * 100) / 100 + "% Efficiency)";
}

/**
 * Clears skill appearance tracker and best outcome if job is suddenly switched
 */
function clearLeftoverData(){
    document.getElementsByName("skillCounter")[0].innerHTML = selectedSkills.length;
    document.getElementsByName("bestOutcome")[0].innerHTML = "0(0 slots for selected and 0 slots for any skill)" ;
    computeAuxData();

}

/**
 * Sort function for headers
 */
$('table[name="sortable"] th').click(function(){
    var table = $(this).parents('table').eq(0)
    var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
    this.asc = !this.asc
    if (!this.asc){rows = rows.reverse()}
    for (var i = 0; i < rows.length; i++){table.append(rows[i])}
})
function comparer(index) {
    return function(a, b) {
        var valA = getCellValue(a, index), valB = getCellValue(b, index)
        return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
    }
}
function getCellValue(row, index){ return $(row).children('td').eq(index).text() }

/**
 * Some minor Web responsive additions
 */
$(window).on('resize load', function () {
    if ($(window).width() < 1000) {
        $("#leftCreator").addClass('col-12').removeClass('col-5');
        $("#rightCreator").addClass('col-12').removeClass('col-7');
        $("#leftCombo").addClass('col-12').removeClass('col-6');
        $("#rightCombo").addClass('col-12').removeClass('col-6');
    } 
    else {
        $("#leftCreator").addClass('col-5').removeClass('col-12');
        $("#rightCreator").addClass('col-7').removeClass('col-12');
        $("#leftCombo").addClass('col-6').removeClass('col-12');
        $("#rightCombo").addClass('col-6').removeClass('col-12');
    }
 });  

/**
 * Allows sections of the page to collapse
 */
function divcollapse(sectionToCollapse){
    $("#"+sectionToCollapse+"").collapse("toggle");
    $("#"+sectionToCollapse+"Arrow").toggleClass("bi bi-caret-down-square-fill");
    $("#"+sectionToCollapse+"Arrow").toggleClass("bi bi-caret-up-square-fill");
}

/**
 * Generates the save string
 */
function genList(){
    var generated;
    generated = logicNumber+"|"+$("#jobSelect").val() +"|";
    for(i = 0; i < nodestones.length; i++){
        generated = generated + skillData[selectedJob].indexOf(nodestones[i][0]) +","+ skillData[selectedJob].indexOf(nodestones[i][1]) +","+ skillData[selectedJob].indexOf(nodestones[i][2])+"|";
    }
    generated = generated.slice(0, -1);
    $("#saveLoadArea").val(generated);
}

/**
 * Loads the pasted save string
 * TODO: Check validity
 */
function loadList(){
    var listLoader = $("#saveLoadArea").val();
    listLoader = listLoader.split("|");
    if(listLoader[0] == logicNumber){
        $("#jobSelect").val(listLoader[1]);
        selectedJob = listLoader[1];
        $("#normalOperation").attr('name', 'noOp');
        $("#helpOperation").attr('name', 'hiddenObj');
        $("#optionOperation").attr('name', 'hiddenObj');
        initializeTally();
        selectorChange();
        clearLeftoverData();
        for(i = 2; i < listLoader.length; i++){
            var temp = listLoader[i].split(",");
            temp[0] = skillData[selectedJob][temp[0]];
            temp[1] = skillData[selectedJob][temp[1]];
            temp[2] = skillData[selectedJob][temp[2]];
            nodestones.push(temp);
            newNode(temp);
        }
    }
    else{
        alert("Your save file is from another version of the Builder. If you think your job was not updated in subsequent revisions, change the first digit in your savefile to " +logicNumber+" and try loading again.");
    }
}

/**
 * Debug function just to check values of variables
 */
function checkVar(){
    console.log("formTrio");
    console.log(formTrio);
    console.log("nodestones");
    console.log(nodestones);
    console.log("selectedSkills");
    console.log(selectedSkills);
    console.log("cannotLead");
    console.log(cannotLead);
    console.log("nodeTally");
    console.log(nodeTally);
    console.log("nodeCollection");
    console.log(nodeCollection);
}

/**
 * Auto Build Function[Starts Here](Do not expect this to work)
 */
 var setholder = [];
 var bigSetHolder = [];

function printCombination(){
    var set = nodestones.slice();
    for(var i = 0; i < nodeCollection.length; i++){
        set = set.filter(function(e) { return e !== nodeCollection[i]});
    }
    var k = Math.ceil(selectedSkills.length*skillCopy/3);
    var results = [];
    bigSetHolder = [];
    setholder = [];
    setholder = nodeCollection.slice();
    if(setholder.length < k){
        results = comboMaker(1+setholder.length, 1+setholder.length, k, set, -1);

    }
    if(results.length > 0){
        autoButtonClick(results[0]);
    }
    else if(setholder.length > k){
        alert("You are currently equipped with more nodestones than the optimal.");
    }
    else{
        alert("No Optimal Nodestone Combination Found.");
    }
    //console.log(results);
}

function comboMaker(currLev, startLev, maxLev, nodePool, basis){
    for(var i = basis+1; i < nodePool.length-maxLev+currLev; i++){
        setholder.push(nodePool[i]);
        if(currLev == maxLev){
            var baseScore = constructScore();
            if(legalLeading(setholder) && legalScoring(setholder, baseScore)){
                //console.log(setholder.toString());
                bigSetHolder.push(setholder.slice());
                return bigSetHolder;
            }
        }
        else if(bigSetHolder.length > 0){
            console.log(bigSetHolder);
            return bigSetHolder;
        }
        else{
            comboMaker(currLev+1, startLev, maxLev, nodePool, i);
        }
        setholder.pop();
    }
    if(currLev == startLev){
        //console.log(bigSetHolder);
        return bigSetHolder;
    }
}

/**
 * 
 * Checks if all the Leading Skill of a nodestone set does not repeat itself
 * 
 */
 function legalLeading(data){
        var leads = [];
        var flag = 0;
        for(var i = 0; i < data.length; i++){
            if(isAlreadyIn(leads, data[i][0])){
                flag = 1;
                break;
            }
            else{
                leads.push(data[i][0]);
            }
        }
        if(flag == 0){
           // console.log(data);
            return true;
        }
        return false;
};

/**
 * 
 * Constructs the basis or comparison to compare whether a nodeset is optimal.
 * 
 */
function constructScore(){
    var scoringCard = {};
    for(var i = 0; i < skillData[selectedJob].length; i++){
        if(isAlreadyIn(selectedSkills,skillData[selectedJob][i])){
            scoringCard[skillData[selectedJob][i]] = -skillCopy;
        }
        else{
            scoringCard[skillData[selectedJob][i]] = 0;
        }
    }
    return scoringCard;
};

/**
 * 
 * Compares a nodeset to the basis
 * 
 */
 function legalScoring(testNodeSet, scoringSystem){
        var currScoreBreak = Object.assign({},scoringSystem);
        var currPotential = 0;
        for(var j = 0; j < testNodeSet.length; j++){
            for(var k = 0; k < 3; k++){
                currScoreBreak[testNodeSet[j][k]]++;
            }
        }
        for(const skillP in currScoreBreak){
            if(currScoreBreak[skillP] < 0){
                currPotential = -1;
            }
        }
        if(currPotential == 0){
        /*    console.log(testNodeSet[i]);
        console.log(currPotential);*/
            //return(testNodeSet[i]);
            return true;
        }
        /*console.log(testNodeSet[i]);
        console.log(currPotential);*/
    return false;
    //return("None Found");
};

function autoButtonClick(nodeToPick){
    for(var f = 0; f < nodeToPick.length; f++){
        var pressThisButton = nodestones.indexOf(nodeToPick[f]);
        $("#nodeList tr[name='"+pressThisButton+"'] td:nth-child(4)").find('button').click();
    }
    alert("Nodestone Combination Found! The Nodes have been equipped for you.");
};